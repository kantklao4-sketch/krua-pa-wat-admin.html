<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เมนู: ครัวป้าวัฒน์</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta property="og:title" content="ครัวป้าวัฒน์">
    <meta property="og:description" content="ลิ้มรสความจัดจ้านแบบดั้งเดิมของอาหารอีสานจากฝีมือแม่ครัวแนวหน้า">
    <meta property="og:image" content="https://placehold.co/1200x630/FFF0F5/4B0082?text=Krua+Pa+Wat">
    <meta property="og:url" content="YOUR_WEBSITE_URL_HERE"> 
    <meta property="og:type" content="website">

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(to bottom right, #FF7F50, #FF6347, #DC143C); 
            color: #ffffff;
            position: relative;
            overflow-x: hidden;
            background-attachment: fixed;
        }
        .bg-card-light {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        .border-card-light {
            border-color: #ddd;
        }
        .hover-effect:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .menu-category-button {
            @apply px-5 py-2 text-white bg-orange-600 rounded-full shadow-lg hover:bg-orange-700 transition-all duration-300;
        }
        .menu-item-card {
            @apply bg-white text-gray-800 p-6 rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 transform;
        }
        .contact-button {
            @apply flex items-center justify-center gap-3 px-6 py-3 font-medium rounded-full shadow-lg transition-transform transform hover:scale-105;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            animation: fade-in 0.3s ease-out;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            color: #333;
            animation: slide-in 0.3s ease-out;
        }
        @keyframes slide-in {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .close-button {
            @apply text-gray-500 hover:text-gray-800 transition-colors duration-200;
        }
        .edit-button-icon {
            @apply absolute top-3 right-3 text-gray-500 hover:text-red-500 transition-colors duration-200 cursor-pointer;
        }
        #message-modal .modal-content, #confirmation-modal .modal-content, #admin-login-modal .modal-content {
            text-align: center;
        }
        #chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column-reverse;
            gap: 0.5rem;
            background-color: #f0f0f0;
        }
        .chat-message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
        }
        .chat-user {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .chat-ai {
            background-color: #e2e2e2;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto px-4 py-12 max-w-6xl relative z-10">
        
        <header class="text-center mb-16">
            <h1 class="text-5xl md:text-7xl font-bold text-red-600 mb-4 drop-shadow-lg">
                ครัวป้าวัฒน์
            </h1>
            <p class="text-3xl md:text-5xl font-bold text-lime-500 mb-4 drop-shadow-lg">
                ก้อยขมต้มแซ่บและอาหารอีสานตามฤดูกาล
            </p>
            <p class="text-lg md:text-xl italic text-white drop-shadow-md">
                ประสบการณ์แม่ครัวแนวหน้าประจำหมู่บ้านมายาวนาน
            </p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8">
                <!-- Add New Menu button, visible only to admin -->
                <button id="add-menu-btn" onclick="openAddModal()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" style="display:none;">
                    <i class="fa-solid fa-plus"></i> เพิ่มเมนูใหม่
                </button>
                <button onclick="openChefChatModal()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    ✨ ถามเชฟเทวดาประจำร้าน
                </button>
                <button onclick="openAdminLoginModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    เข้าสู่ระบบ Admin
                </button>
            </div>
            <div class="mt-4 text-sm text-white">
                <p>User ID: <span id="user-id-display">...</span></p>
                <p>Admin ID: <span id="admin-id-display">...</span></p>
            </div>
        </header>

        <main>
            
            <div id="menu-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Menu items will be dynamically generated here -->
            </div>
            
        </main>

        <footer class="mt-16 text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">ติดต่อเรา</h2>
            <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                <!-- ลิงก์ LINE ที่ถูกแก้ไขให้แสดง QR Code เมื่อคลิก -->
                <a href="#" onclick="showQrModal()" class="contact-button bg-green-500 hover:bg-green-600 text-white">
                    <i class="fa-brands fa-line fa-2x"></i> <span>Line</span>
                </a>
                <!-- ลิงก์เบอร์โทรศัพท์ที่ถูกแก้ไข -->
                <a href="tel:0862375274" class="contact-button bg-blue-500 hover:bg-blue-600 text-white">
                    <i class="fa-solid fa-phone fa-2x"></i> <span>โทรศัพท์</span>
                </a>
            </div>
            <p class="text-xs text-gray-300 mt-6">
                © 2024 ครัวป้าวัฒน์
            </p>
        </footer>

    </div>

    <!-- Modal for LINE QR Code -->
    <div id="qr-modal" class="modal">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-2xl font-semibold">สแกนเพื่อเพิ่มเพื่อน LINE</h3>
                <button onclick="closeQrModal()" class="close-button text-3xl">&times;</button>
            </div>
            <img src="https://qr-official.line.me/gs/M_792jvkar_GW.png?oat_content=qr" alt="LINE QR Code" class="w-full h-auto mx-auto my-4 rounded-lg shadow-lg">
            <p class="text-gray-600">สแกน QR Code นี้เพื่อแอด Line</p>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 id="modal-title" class="text-2xl font-semibold">แก้ไขเมนู</h3>
                <button onclick="closeModal()" class="close-button text-3xl">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label for="edit-name" class="block text-gray-700 font-bold mb-2">ชื่อเมนู</label>
                    <input type="text" id="edit-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label for="edit-description" class="block text-gray-700 font-bold">คำอธิบาย</label>
                        <button type="button" onclick="generateDescription()" id="generate-desc-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded-full hover:bg-purple-600 transition-colors duration-200">
                            ✨ ให้ AI ช่วยเขียน
                        </button>
                    </div>
                    <textarea id="edit-description" class="w-full p-2 border rounded h-24" required></textarea>
                </div>
                <div class="mb-4">
                    <label for="edit-price" class="block text-gray-700 font-bold mb-2">ราคา (เช่น "50 บาท/ถุง")</label>
                    <input type="text" id="edit-price" class="w-full p-2 border rounded" required>
                </div>
                <div class="flex justify-between gap-4 mt-6">
                    <button type="button" onclick="deleteItem()" id="delete-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 flex-1" style="display:none;">ลบเมนู</button>
                    <div class="flex flex-1 justify-end gap-4">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">บันทึก</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Chef Chat Modal -->
    <div id="chef-chat-modal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-2xl font-semibold">คุยกับเชฟเทวดาประจำร้าน</h3>
                <button onclick="closeChefChatModal()" class="close-button text-3xl">&times;</button>
            </div>
            <div id="chat-container">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="ถามคำถามเกี่ยวกับอาหาร..." class="flex-1 p-2 border rounded-full">
                <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded-full hover:bg-purple-600">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold mb-4">เข้าสู่ระบบ Admin</h3>
            <p class="mb-4 text-gray-600">กรุณากรอก Admin ID ที่ต้องการเข้าสู่ระบบ</p>
            <input type="text" id="admin-id-input" class="w-full p-2 border rounded-lg mb-4 text-center text-gray-700" placeholder="กรอก Admin ID">
            <div class="flex justify-center gap-4">
                <button onclick="loginAsAdmin()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">ยืนยัน</button>
                <button onclick="closeAdminLoginModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <div id="message-content"></div>
            <button onclick="closeMessageModal()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ปิด</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <div id="confirmation-message" class="mb-6 text-xl font-medium"></div>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-button" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">ใช่, ลบเลย</button>
                <button onclick="closeConfirmationModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, setDoc, doc, getDocs, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore debug logs for better debugging
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // API key is handled automatically by the environment

        let db, auth;
        let userId;
        let menuCollection;
        let confirmationCallback = null;
        let chatHistory = [];

        // Define a hardcoded Admin ID for this application
        const ADMIN_USER_ID = "admin-12345"; 

        const menuContainer = document.getElementById('menu-container');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const deleteButton = document.getElementById('delete-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const qrModal = document.getElementById('qr-modal');
        const chefChatModal = document.getElementById('chef-chat-modal');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const generateDescBtn = document.getElementById('generate-desc-btn');
        const editNameInput = document.getElementById('edit-name');
        const editDescInput = document.getElementById('edit-description');
        const addMenuBtn = document.getElementById('add-menu-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const adminIdDisplay = document.getElementById('admin-id-display');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminIdInput = document.getElementById('admin-id-input');

        const menuData = [
            { id: "larb-moo", name: "ลาบหมู", description: "ลาบหมูสับคลุกเคล้ากับข้าวคั่วหอมๆ พริกป่น มะนาว และหอมแดง ปรุงรสจัดจ้าน", price: "50 บาท/ถุง", icon: "fa-pepper-hot" },
            { id: "larb-nuea", name: "ลาบเนื้อ", description: "ลาบเนื้อวัวสับแบบอีสานแท้ ปรุงรสด้วยเครื่องเทศหอมๆ", price: "50 บาท/ถุง", icon: "fa-bowl-food" },
            { id: "koi-nuea", name: "ก้อยเนื้อ", description: "ก้อยเนื้อดิบสับปรุงรสจัดจ้านกับพริกป่นและข้าวคั่ว", price: "50 บาท/ถุง", icon: "fa-utensils" },
            { id: "tom-nuea", name: "ต้มเนื้อ", description: "ซุปต้มเนื้อรสชาติเปรี้ยวเผ็ด เค็ม กลมกล่อม เนื้อเปื่อยนุ่ม", price: "40 บาท/ถุง", icon: "fa-hot-tub-person" },
            { id: "nuea-moo-dad-diao", name: "เนื้อ/หมูแดดเดียว", description: "เนื้อ/หมูหมักสูตรพิเศษนำไปทอดจนเหลืองกรอบนอกนุ่มใน ทอดด้วยหม้อทอดไร้น้ำมัน", price: "50 บาท/ชุด", icon: "fa-sun-plant-wilt" },
            { id: "khao-niao", name: "ข้าวเหนียว", description: "ข้าวเหนียวนึ่งใหม่ๆ หอมกรุ่น ทานคู่กับอาหารอีสานเข้ากันสุดๆ", price: "10 บาท/ถุง", icon: "fa-seedling" }
        ];

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in anonymously by default
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        adminIdDisplay.textContent = ADMIN_USER_ID;

                        const isUserAdmin = userId === ADMIN_USER_ID;
                        addMenuBtn.style.display = isUserAdmin ? 'inline-block' : 'none';

                        const menuCollectionPath = `artifacts/${appId}/public/data/menu`;
                        menuCollection = collection(db, menuCollectionPath);
                        
                        await checkAndPopulateMenu();
                        
                        onSnapshot(menuCollection, (snapshot) => {
                            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderMenu(items, isUserAdmin);
                        }, (error) => {
                            console.error("Error listening to Firestore:", error);
                            showMessageModal(`เกิดข้อผิดพลาดในการโหลดเมนู: ${error.message}`);
                        });
                    } else {
                        console.log("No user signed in.");
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageModal(`เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล: ${error.message}`);
            }
        }
        
        async function checkAndPopulateMenu() {
            try {
                const snapshot = await getDocs(menuCollection);
                if (snapshot.empty) {
                    console.log("Populating menu for the first time...");
                    for (const item of menuData) {
                        await setDoc(doc(menuCollection, item.id), item);
                    }
                }
            } catch (error) {
                console.error("Error populating menu:", error);
                showMessageModal(`เกิดข้อผิดพลาดในการเพิ่มเมนูเริ่มต้น: ${error.message}`);
            }
        }

        function renderMenu(items, isUserAdmin) {
            menuContainer.innerHTML = '';
            items.sort((a, b) => a.name.localeCompare(b.name, 'th'));
            items.forEach(item => {
                const editButtonHtml = isUserAdmin ? 
                    `<button onclick="openModal('${item.id}', '${item.name}', \`${item.description}\`, '${item.price}')" class="edit-button-icon">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>` : '';

                const itemHtml = `
                    <div class="bg-card-light text-gray-800 rounded-xl p-6 border border-card-light hover-effect relative">
                        <h3 class="text-2xl font-semibold mb-2 ${item.icon && (item.icon.includes('hot-tub') || item.icon.includes('seedling')) ? 'text-lime-500' : 'text-red-600'}">
                            <i class="fa-solid ${item.icon}"></i> ${item.name}
                        </h3>
                        <p class="text-gray-600 mb-4">
                            ${item.description}
                        </p>
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span class="text-orange-500">${item.price}</span>
                            <button class="bg-red-600 px-4 py-1 rounded-full text-white text-base">
                                สั่งเลย
                            </button>
                        </div>
                        ${editButtonHtml}
                    </div>
                `;
                menuContainer.innerHTML += itemHtml;
            });
        }

        function showMessageModal(message) {
            document.getElementById('message-content').innerHTML = `<p>${message}</p>`;
            messageModal.style.display = 'flex';
        }

        window.closeMessageModal = () => {
            messageModal.style.display = 'none';
        };

        window.openAddModal = () => {
            if (userId !== ADMIN_USER_ID) {
                showMessageModal("คุณไม่มีสิทธิ์ในการเพิ่มเมนู");
                return;
            }
            modalTitle.textContent = "เพิ่มเมนูใหม่";
            document.getElementById('edit-id').value = "";
            document.getElementById('edit-name').value = "";
            document.getElementById('edit-description').value = "";
            document.getElementById('edit-price').value = "";
            deleteButton.style.display = 'none';
            editModal.style.display = 'flex';
        };

        window.openModal = (id, name, description, price) => {
            if (userId !== ADMIN_USER_ID) {
                showMessageModal("คุณไม่มีสิทธิ์ในการแก้ไขเมนู");
                return;
            }
            modalTitle.textContent = "แก้ไขเมนู";
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-description').value = description;
            document.getElementById('edit-price').value = price;
            deleteButton.style.display = 'block';
            editModal.style.display = 'flex';
        };

        window.closeModal = () => {
            editModal.style.display = 'none';
        };

        window.showQrModal = () => {
            qrModal.style.display = 'flex';
        };

        window.closeQrModal = () => {
            qrModal.style.display = 'none';
        };

        window.openChefChatModal = () => {
            chefChatModal.style.display = 'flex';
        };

        window.closeChefChatModal = () => {
            chefChatModal.style.display = 'none';
        };

        window.openAdminLoginModal = () => {
            adminLoginModal.style.display = 'flex';
        };

        window.closeAdminLoginModal = () => {
            adminLoginModal.style.display = 'none';
        };

        window.loginAsAdmin = async () => {
            const enteredId = adminIdInput.value.trim();
            if (enteredId === ADMIN_USER_ID) {
                closeAdminLoginModal();
                showMessageModal("เข้าสู่ระบบในฐานะ Admin เรียบร้อยแล้ว!");
                // Note: In a real app, you would have a backend to generate a custom token for the admin.
                // For this example, we'll just rely on the hardcoded ID check.
            } else {
                showMessageModal("Admin ID ไม่ถูกต้อง");
            }
        };

        window.deleteItem = async () => {
            if (userId !== ADMIN_USER_ID) {
                showMessageModal("คุณไม่มีสิทธิ์ในการลบเมนู");
                closeModal();
                return;
            }

            const id = document.getElementById('edit-id').value;
            showConfirmationModal("คุณแน่ใจหรือไม่ว่าต้องการลบเมนูนี้?", async () => {
                try {
                    const itemRef = doc(menuCollection, id);
                    await deleteDoc(itemRef);
                    closeModal();
                    showMessageModal("ลบเมนูสำเร็จ!");
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showMessageModal(`เกิดข้อผิดพลาดในการลบเมนู: ${error.message}`);
                }
            });
        };

        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmationCallback = callback;
            confirmationModal.style.display = 'flex';
        }

        function closeConfirmationModal() {
            confirmationModal.style.display = 'none';
            confirmationCallback = null;
        }

        confirmYesButton.onclick = () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            closeConfirmationModal();
        };

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (userId !== ADMIN_USER_ID) {
                showMessageModal("คุณไม่มีสิทธิ์ในการบันทึกเมนู");
                return;
            }
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const description = document.getElementById('edit-description').value;
            const price = document.getElementById('edit-price').value;
            
            try {
                if (id) {
                    const itemRef = doc(menuCollection, id);
                    await setDoc(itemRef, { name, description, price }, { merge: true });
                    showMessageModal("แก้ไขเมนูสำเร็จ!");
                } else {
                    const newItem = {
                        name,
                        description,
                        price,
                        icon: "fa-utensils"
                    };
                    await addDoc(menuCollection, newItem);
                    showMessageModal("เพิ่มเมนูใหม่สำเร็จ!");
                }
                closeModal();
            } catch (error) {
                console.error("Error saving document: ", error);
                showMessageModal(`เกิดข้อผิดพลาดในการบันทึกเมนู: ${error.message}`);
            }
        });

        // Gemini API functions
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

        async function generateDescription() {
            const name = editNameInput.value;
            if (!name) {
                showMessageModal("กรุณาใส่ชื่อเมนูเพื่อใช้ AI ช่วยเขียนคำอธิบาย");
                return;
            }

            generateDescBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังเขียน...';
            generateDescBtn.disabled = true;

            const userPrompt = `คุณเป็นนักเขียนเมนูอาหารไทยมืออาชีพ กรุณาเขียนคำอธิบายเมนูอาหารที่น่าสนใจและน่ารับประทานสำหรับเมนูชื่อ "${name}" โดยเน้นการใช้คำที่สื่อถึงความอร่อยและรสชาติแบบจัดจ้านสไตล์อาหารอีสาน เขียนสั้นๆ เพียงหนึ่งย่อหน้า`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: "คุณคือผู้เชี่ยวชาญด้านอาหารไทยและภาษาไทย" }]
                }
            };

            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            const callApi = async () => {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) {
                        const delay = initialDelay * Math.pow(2, retries);
                        retries++;
                        return new Promise(resolve => setTimeout(() => resolve(callApi()), delay));
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            };

            try {
                const result = await callApi();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (generatedText) {
                    editDescInput.value = generatedText;
                } else {
                    showMessageModal("ไม่สามารถสร้างคำอธิบายได้ กรุณาลองใหม่อีกครั้ง");
                }
            } catch (error) {
                console.error('Error generating description:', error);
                showMessageModal(`เกิดข้อผิดพลาดในการใช้ AI: ${error.message}`);
            } finally {
                generateDescBtn.innerHTML = '✨ ให้ AI ช่วยเขียน';
                generateDescBtn.disabled = false;
            }
        }

        async function sendMessage(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            chatHistory.push({ role: "user", parts: [{ text: message }] });
            appendMessage(message, "chat-user");
            chatInput.value = "";
            chatInput.disabled = true;

            const thinkingMessage = document.createElement("div");
            thinkingMessage.className = "chat-message chat-ai animate-pulse";
            thinkingMessage.textContent = "AI กำลังคิดคำตอบ...";
            chatContainer.prepend(thinkingMessage);

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: "คุณคือเชฟ AI ที่มีความรู้เกี่ยวกับอาหารไทย อาหารอีสาน และเมนูท้องถิ่นต่างๆ ตอบคำถามด้วยความเชี่ยวชาญและเป็นมิตร" }]
                }
            };

            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            const callApi = async () => {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) {
                        const delay = initialDelay * Math.pow(2, retries);
                        retries++;
                        return new Promise(resolve => setTimeout(() => resolve(callApi()), delay));
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            };

            try {
                const result = await callApi();
                const aiResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                chatContainer.removeChild(thinkingMessage);
                appendMessage(aiResponse, "chat-ai");
            } catch (error) {
                console.error('Error sending message:', error);
                chatContainer.removeChild(thinkingMessage);
                appendMessage("ขออภัย เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง", "chat-ai");
            } finally {
                chatInput.disabled = false;
            }
        }

        function appendMessage(text, className) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `chat-message ${className}`;
            messageDiv.textContent = text;
            chatContainer.prepend(messageDiv);
        }

        // Add event listeners and global functions
        window.generateDescription = generateDescription;
        window.openChefChatModal = openChefChatModal;
        window.closeChefChatModal = closeChefChatModal;
        window.openAdminLoginModal = openAdminLoginModal;
        window.closeAdminLoginModal = closeAdminLoginModal;
        window.loginAsAdmin = loginAsAdmin;
        chatForm.addEventListener('submit', sendMessage);

        initFirebase();
    </script>
</body>
</html>
